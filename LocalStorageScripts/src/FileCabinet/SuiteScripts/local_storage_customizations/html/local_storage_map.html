<!DOCTYPE html>
<html>

<head>
    <title>
        Local Storage Floor Map
    </title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v9.0.0/ol.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />


    <style>
        :root {
            /* --available-color: #41B06E;
            --occupied-color: #E72929;
            --available-soon-color: #FFC94A;
            --not-available-color: #B4B4B8; */

            --occupied-color: #fff;
            --available-color: #00CC99;
            --available-soon-color: #FCC115;
            --not-available-color: #29ABE2;
            --expired: #FF6666;
            --filter-by-size: #AC82D1
        }

        body {
            padding: 20px 20px;
            background-color: #F4EFE6;
        }

        .map {
            border: 1px solid #dee2e6;
            background-color: #EFE4D3;
            margin: 15px 0px;
            padding: 20px 0px;
            border-radius: 7px;
            width: 100%;
            height: 80vh;
        }

        .tooltip {
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 4px;
            border-radius: 4px;
            font-size: 12px;
        }

        td {
            padding: 0 0.5em;
            text-align: right;
        }

        .legend-box {
            width: 1rem;
            height: 1rem;
            display: inline-block;
            background-color: blue;
        }

        .legend-list li {
            display: inline-block;
            list-style: none;
            margin-right: 20px;
        }

        .popover-body {
            width: auto;
            min-width: 175px;
            /* width: auto; */
            /* width: max-content; */
        }

        .customer-name-text {
            overflow: hidden;
            -ms-text-overflow: ellipsis;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .text-label {
            font-size: 7px;
            color: #333333;
        }

        div#loading-overlay {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 10;
            opacity: 0.8;
            background-color: #000;
        }

        #map-container {
            position: relative;
        }

        #search-container {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            z-index: 1000;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        #coordinate-input {
            width: 200px;
        }

        #search-button {
            margin-left: 10px;
        }

        .select2-selection__arrow {
            display: none;
        }

        input:focus-visible {
            outline: none !important;
        }

        ::-webkit-scrollbar-track {
            -webkit-box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.3);
            background-color: #F5F5F5;
            border-radius: 10px;
        }

        ::-webkit-scrollbar {
            width: 10px;
            background-color: #F5F5F5;
        }

        ::-webkit-scrollbar-thumb {
            background-color: #727272;
            border-radius: 10px;
            /* background-image: -webkit-linear-gradient(0deg,
                    rgba(255, 255, 255, 0.5) 25%,
                    transparent 25%,
                    transparent 50%,
                    rgba(255, 255, 255, 0.5) 50%,
                    rgba(255, 255, 255, 0.5) 75%,
                    transparent 75%,
                    transparent) */
        }

        .select2-container--default .select2-selection--single {
            border: 1px solid #ced4da;
            border-radius: .375rem;
            transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right .25rem center;
            background-size: 16px 12px;

        }

        .select2-container .select2-selection--single {
            height: 37px;
            padding-top: 3px;
            padding-left: 4px;
        }

        .spinner-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
    </style>
</head>

<body>
    <div id="loading-overlay">
        <div class="spinner-container">
            <div class="spinner-border text-warning" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <!-- <div class="text-center">
            <div class="spinner-border text-warning" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div> -->
    </div>

    <div class="container">
        <div class="row">
            <div class="col-12 text-center mb-5">
                <img style="max-width: 300px;"
                    src="https://8977849.app.netsuite.com/core/media/media.nl?id=1878&c=8977849&h=BZtc85zOxBw_M_hShm6RiZfOwbPXPwVgT_t3PtzmuYdO_HXf"
                    alt="local Storage Logo">
            </div>
            <div class="col-12 col-md-2">
                <select id="floor_select" class="form-select form-select-md" aria-label=".form-select-lg example">
                    <option value="3" selected>Ground Floor</option>
                    <option value="1">Floor 1</option>
                    <option value="2">Floor 2</option>
                </select>
            </div>
            <div class="col-12 col-md-2">
                <select id='unit_slect2_search' class="form-select form-select-md" name="state">
                    <option value="" disabled selected>Search Storage Unit</option>
                </select>
            </div>
            <div class="col-12 col-md-2">
                <select id="floor_unit_size_filter" class="form-select form-select-md">
                    <option value=""></option>
                    <option value="1"><span id="small_unit_total"></span> Small (0-100)</span></option>
                    <option value="2"><span id="medium_unit_total"></span> Medium (100-150)</option>
                    <option value="3"><span id="large_unit_total"></span>Large (150 >)</option>
                </select>
            </div>
            <!-- <div class="col-12 col-md-2">
                <ul id="summary-detail"></ul>
                <button id="loading-btn" class="btn btn-primary"><svg xmlns="http://www.w3.org/2000/svg" width="16"
                        height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z" />
                        <path
                            d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466" />
                    </svg><span class="ms-1">Reload</span> </button> 
            </div>-->
            <div class="col-12 col-md-12 text-end mt-3">
                <ul class="legend-list ps-0">
                    <li>
                        <span class="legend-box" style="background-color:var(--occupied-color)"></span>
                        Occupied <span id="occupied_units" class="me-2"></span>
                    </li>
                    <li>
                        <span class="legend-box" style="background-color: var(--available-color)"></span>
                        Available <span id="availaible_units" class="me-2"></span>
                    </li>
                    <li>
                        <span class="legend-box" style="background-color: var(--available-soon-color)"></span> Available
                        in two weeks <span id="availaible_soon_units" class="me-2"></span>
                    </li>
                    <li>
                        <span class="legend-box" style="background-color: var(--expired)"></span> Expire
                        <span id="expire_units" class="me-2">0</span>
                    </li>
                    <li>
                        <span class="legend-box" style="background-color: var(--not-available-color)"></span> Not
                        available <span id="not_availaible_units" class="me-2"></span>
                    </li>
                    <li>
                        <span class="legend-box" style="background-color: var(--filter-by-size)"></span> Filter by
                        size <span id="filter_by_size" class="me-2"></span>
                    </li>
                </ul>
            </div>
            <!-- <div class="col-12 col-md-3">
                <select id="storage_filter" class="form-select form-select-md mb-3"
                    aria-label=".form-select-lg example">
                    <option selected>All</option>
                    <option value="OCCUPIED">Occupied</option>
                    <option value="AVAILABLE">Available</option>
                    <option value="AVAILABLE_SOON">Available in two weeks</option>
                    <option value="NOT_AVAILABLE">Not Available</option>
                </select>
            </div> -->
            <div class="col-12">
                <div id="floor_map" class="map">
                    <div id="info_popup">
                    </div>
                </div>
                <!-- <div id="search-container">
                    <input type="text" id="name-input" placeholder="Enter feature name">
                    <button id="search-button">Search</button>
                </div> -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ol@v9.0.0/dist/ol.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js"
        integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script>
        $(document).ready(function () {
            const zoomLevel = {
                maxZoom: 19,
                minZoom: 16
            }
            const floorIds = {
                FLOOR_1: '1',
                FLOOR_2: '2',
                GROUND_FLOOR: '3',
            }

            const unitStorageDoorPosition = {
                TOP: "1",
                BOTTOM: "2",
                RIGHT: "3",
                LEFT: "4",
                RIGHT_BOTTOM: "5",
                TOP_RIGHT: "6",
                BOTTOM_RIGHT: "7",
                TOP_LEFT: "8",
                RIGHT_TOP: "9"
            }

            const Ground_floor_corridor = [

                { coordinates: [-19, 200], text: 'C-02', rotation: '1.570796327' },
                { coordinates: [-19, 400], text: 'C-02', rotation: '1.570796327' },
                { coordinates: [-19, 550], text: 'C-02', rotation: '1.570796327' },
                { coordinates: [-25, -170], text: 'C-02', rotation: '1.570796327' },
                { coordinates: [-25, -380], text: 'C-02', rotation: '1.570796327' },
                { coordinates: [-25, -520], text: 'C-02', rotation: '1.570796327' },
                { coordinates: [30, 245], text: 'C-10', rotation: '0' },
                { coordinates: [300, 245], text: 'C-10', rotation: '0' },
                { coordinates: [530, 245], text: 'C-10', rotation: '0' },
                { coordinates: [30, 362], text: 'C-11', rotation: '0' },
                { coordinates: [300, 362], text: 'C-11', rotation: '0' },
                { coordinates: [530, 362], text: 'C-11', rotation: '0' },
                { coordinates: [30, 491], text: 'C-12', rotation: '0' },
                { coordinates: [300, 491], text: 'C-12', rotation: '0' },
                { coordinates: [530, 491], text: 'C-12', rotation: '0' },
                { coordinates: [30, 612], text: 'C-13', rotation: '0' },
                { coordinates: [300, 612], text: 'C-13', rotation: '0' },
                { coordinates: [530, 612], text: 'C-13', rotation: '0' },
                { coordinates: [90, -555], text: 'C-03', rotation: '0' },
                { coordinates: [390, -555], text: 'C-03', rotation: '0' },
                { coordinates: [730, -555], text: 'C-03', rotation: '0' },
                { coordinates: [90, -440], text: 'C-04', rotation: '0' },
                { coordinates: [390, -440], text: 'C-04', rotation: '0' },
                { coordinates: [730, -440], text: 'C-04', rotation: '0' },
                { coordinates: [90, -313], text: 'C-05', rotation: '0' },
                { coordinates: [390, -313], text: 'C-05', rotation: '0' },
                { coordinates: [730, -313], text: 'C-05', rotation: '0' },
                { coordinates: [90, -207], text: 'C-06', rotation: '0' },
                { coordinates: [390, -207], text: 'C-06', rotation: '0' },
                { coordinates: [730, -207], text: 'C-06', rotation: '0' },
                { coordinates: [-270, -150], text: 'C-01', rotation: '1.570796327' },
                { coordinates: [-270, -280], text: 'C-01', rotation: '1.570796327' },
                { coordinates: [-305, 100], text: 'C-01', rotation: '1.570796327' },
                { coordinates: [-305, 300], text: 'C-01', rotation: '1.570796327' },

            ];

            const first_floor_corridor = [

                { coordinates: [-215.5, 200], text: 'C-02', rotation: '1.570796327' },
                { coordinates: [-215.5, 380], text: 'C-02', rotation: '1.570796327' },
                { coordinates: [-215.5, 500], text: 'C-02', rotation: '1.570796327' },
                { coordinates: [-215.5, -130], text: 'C-02', rotation: '1.570796327' },
                { coordinates: [-217, -300], text: 'C-02', rotation: '1.570796327' },
                { coordinates: [-217, -460], text: 'C-02', rotation: '1.570796327' },
                { coordinates: [-40, -565], text: 'C-03', rotation: '0' },
                { coordinates: [250, -565], text: 'C-03', rotation: '0' },
                { coordinates: [600, -565], text: 'C-03', rotation: '0' },
                { coordinates: [-40, -445], text: 'C-04', rotation: '0' },
                { coordinates: [250, -445], text: 'C-04', rotation: '0' },
                { coordinates: [600, -445], text: 'C-04', rotation: '0' },
                { coordinates: [-40, -325], text: 'C-05', rotation: '0' },
                { coordinates: [250, -325], text: 'C-05', rotation: '0' },
                { coordinates: [600, -325], text: 'C-05', rotation: '0' },
                { coordinates: [-40, -175], text: 'C-06', rotation: '0' },
                { coordinates: [250, -175], text: 'C-06', rotation: '0' },
                { coordinates: [600, -175], text: 'C-06', rotation: '0' },
                { coordinates: [-150, 180], text: 'C-10', rotation: '0' },
                { coordinates: [50, 180], text: 'C-10', rotation: '0' },
                { coordinates: [280, 180], text: 'C-10', rotation: '0' },
                { coordinates: [30, 335], text: 'C-11', rotation: '0' },
                { coordinates: [300, 335], text: 'C-11', rotation: '0' },
                { coordinates: [30, 445], text: 'C-12', rotation: '0' },
                { coordinates: [300, 445], text: 'C-12', rotation: '0' },
                { coordinates: [-130, 554], text: 'C-13', rotation: '0' },
                { coordinates: [30, 553], text: 'C-13', rotation: '0' },
                { coordinates: [300, 553], text: 'C-13', rotation: '0' },
            ];

            const second_floor_corridor = [

                { coordinates: [-108, 200], text: 'C-02', rotation: '1.570796327' },
                { coordinates: [-108, 380], text: 'C-02', rotation: '1.570796327' },
                { coordinates: [-108, 500], text: 'C-02', rotation: '1.570796327' },
                { coordinates: [-108, -130], text: 'C-02', rotation: '1.570796327' },
                { coordinates: [-108, -300], text: 'C-02', rotation: '1.570796327' },
                { coordinates: [-108, -460], text: 'C-02', rotation: '1.570796327' },
                { coordinates: [-40, -595], text: 'C-03', rotation: '0' },
                { coordinates: [250, -595], text: 'C-03', rotation: '0' },
                { coordinates: [600, -595], text: 'C-03', rotation: '0' },
                { coordinates: [160, -427], text: 'C-04', rotation: '0' },
                { coordinates: [340, -427], text: 'C-04', rotation: '0' },
                { coordinates: [570, -427], text: 'C-04', rotation: '0' },
                { coordinates: [-40, -305], text: 'C-05', rotation: '0' },
                { coordinates: [250, -305], text: 'C-05', rotation: '0' },
                { coordinates: [600, -305], text: 'C-05', rotation: '0' },
                { coordinates: [-40, -190], text: 'C-06', rotation: '0' },
                { coordinates: [250, -190], text: 'C-06', rotation: '0' },
                { coordinates: [600, -190], text: 'C-06', rotation: '0' },
                { coordinates: [-40, 165], text: 'C-10', rotation: '0' },
                { coordinates: [150, 165], text: 'C-10', rotation: '0' },
                { coordinates: [410, 165], text: 'C-10', rotation: '0' },
                { coordinates: [150, 335], text: 'C-11', rotation: '0' },
                { coordinates: [400, 335], text: 'C-11', rotation: '0' },
                { coordinates: [-40, 580], text: 'C-12', rotation: '0' },
                { coordinates: [150, 580], text: 'C-12', rotation: '0' },
                { coordinates: [410, 580], text: 'C-12', rotation: '0' },
            ];

            let currentFloor1View;
            let currentFloor2View;
            let currentMap;
            let data;
            let textOverlays = {};
            let highlightedFeatures = [];
            let popover;
            let endPoint = location.href;
            let mapArr;
            let url = new URL(endPoint);

            // $('#unit_slect2_search').select2({ placeholder: "Select a unit", allowClear: true });
            // $('#floor_unit_size_filter').select2({ placeholder: 'Filter by Size', allowClear: true });

            function initializeMap(targetElement, mapDataArr, corridorTextFeatures) {
                console.log("mapDataArr", mapDataArr);

                const baseLayer = new ol.layer.Tile();
                const vectorSource = new ol.source.Vector();

                const vectorLayer = new ol.layer.Vector({
                    source: vectorSource,
                    style: function (feature) {
                        const status = feature.get('status');
                        let fillColor;

                        if (status) {
                            switch (status.label) {
                                case 'Occupied': fillColor = '#F2F2F2'; break;
                                case 'Available': fillColor = '#00CC99'; break;
                                case 'AVAILABLE_IN_TWO_WEEKS': fillColor = '#FCC115'; break;
                                case 'NOT_AVAILABLE': fillColor = '#29ABE2'; break;
                                case 'EXPIRE': fillColor = '#FF6666'; break;
                                default: fillColor = '';
                            }
                        } else {
                            fillColor = "#000000"
                        }

                        return new ol.style.Style({
                            fill: new ol.style.Fill({ color: fillColor }),
                            stroke: new ol.style.Stroke({ color: '#F2EFE5', width: 0.5 })
                        });
                    }
                });

                const corridorTextLayer = new ol.layer.Vector({
                    source: new ol.source.Vector(),
                    style: new ol.style.Style({
                        text: new ol.style.Text({
                            font: '12px Calibri,sans-serif',
                            overflow: true,
                            fill: new ol.style.Fill({ color: '#000' }),
                            stroke: new ol.style.Stroke({ color: '#fff', width: 3 }),
                        })
                    })
                });

                const map = new ol.Map({
                    layers: [baseLayer, vectorLayer, corridorTextLayer],
                    target: targetElement,
                    view: new ol.View({ maxZoom: zoomLevel.maxZoom, minZoom: zoomLevel.minZoom }),
                });

                function updateTextLabelSizes() {
                    const zoom = map.getView().getZoom();
                    let fontSize = zoom <= 17 ? zoom - 15 : zoom - 9;
                    document.querySelectorAll('.text-label').forEach(el => {
                        el.style.fontSize = `${fontSize}pt`;
                    });
                }

                function searchByName(selectedLabel) {

                    if (!selectedLabel) {
                        alert('Please enter a feature name');
                        return;
                    }

                    const features = vectorSource.getFeatures();
                    const feature = features.find(f => f.get('label') === selectedLabel);

                    // if (!feature) {
                    //     alert('Feature not found');
                    //     return;
                    // }

                    if (feature) {
                        const extent = feature.getGeometry().getExtent();
                        console.log("selected feature", feature)
                        map.getView().fit(extent, { padding: [10, 10, 10, 10], maxZoom: 18 });

                        const highlightStyle = new ol.style.Style({
                            stroke: new ol.style.Stroke({
                                color: 'black',
                                width: 1
                            }),
                            fill: new ol.style.Fill({
                                color: '#333333'
                            })
                        });

                        console.log("textOverlays", textOverlays)
                        const selectedUnitToLowerCase = selectedLabel.toLowerCase()
                        const textElement = textOverlays[selectedUnitToLowerCase];
                        console.log("textElement", textElement)
                        if (textElement) {
                            textElement.style.color = 'white';
                        }

                        feature.setStyle(highlightStyle);
                        setTimeout(() => {
                            feature.setStyle(null);
                            textElement.style.color = '#333333'
                        }, 4000);
                    }
                }

                function getDoorPoint(doorPosition, extent) {
                    const topMidPoint = [(extent[0] + extent[2]) / 2, extent[3]];
                    const bottomMidpoint = [(extent[0] + extent[2]) / 2, extent[1]];
                    const rightMidpoint = [extent[2], (extent[1] + extent[3]) / 2];
                    const leftMidpoint = [extent[0], (extent[1] + extent[3]) / 2];
                    const RightBottom = [extent[2], extent[1] + 15];
                    const topRight = [extent[2] - 15, extent[3]];
                    const topLeft = [extent[0] + 15, extent[3]];
                    const bottomRight = [extent[2] - 15, extent[1]];
                    const RightTop = [extent[2], extent[3] - 15];

                    switch (doorPosition) {
                        case unitStorageDoorPosition.TOP: return topMidPoint;
                        case unitStorageDoorPosition.BOTTOM: return bottomMidpoint;
                        case unitStorageDoorPosition.RIGHT: return rightMidpoint;
                        case unitStorageDoorPosition.LEFT: return leftMidpoint;
                        case unitStorageDoorPosition.RIGHT_BOTTOM: return RightBottom;
                        case unitStorageDoorPosition.TOP_RIGHT: return topRight;
                        case unitStorageDoorPosition.BOTTOM_RIGHT: return bottomRight;
                        case unitStorageDoorPosition.TOP_LEFT: return topLeft;
                        case unitStorageDoorPosition.RIGHT_TOP: return RightTop;
                    }
                }

                function getLineCoordinates(doorPosition, doorPoint) {
                    const lineHeight = 30;
                    switch (doorPosition) {
                        case unitStorageDoorPosition.TOP:
                            return [[doorPoint[0] - 8, doorPoint[1]], [doorPoint[0] + 8, doorPoint[1]]];
                        case unitStorageDoorPosition.BOTTOM:
                            return [[doorPoint[0] - 8, doorPoint[1]], [doorPoint[0] + 8, doorPoint[1]]];
                        case unitStorageDoorPosition.RIGHT:
                            return [[doorPoint[0], doorPoint[1] - (lineHeight / 5)], [doorPoint[0], doorPoint[1] + (lineHeight / 5)]];
                        case unitStorageDoorPosition.LEFT:
                            return [
                                [doorPoint[0], doorPoint[1] - (lineHeight / 5)], // Top endpoint of the line
                                [doorPoint[0], doorPoint[1] + (lineHeight / 5)]  // Bottom endpoint of the line
                            ];
                        case unitStorageDoorPosition.RIGHT_BOTTOM:
                            return [
                                [doorPoint[0], doorPoint[1] - (lineHeight / 5)],
                                [doorPoint[0], doorPoint[1] + (lineHeight / 5)]
                            ];
                        case unitStorageDoorPosition.RIGHT_TOP:
                            return [[doorPoint[0], doorPoint[1] - (lineHeight / 5)], [doorPoint[0], doorPoint[1] + (lineHeight / 5)]];
                        default:
                            return '';
                    }
                }

                function createTextOverlay(feature, label, index, width, height, areaInFeet) {
                    const geometry = feature.getGeometry();
                    const center = ol.extent.getCenter(geometry.getExtent());
                    const doorPosition = feature.get('doorPosition');
                    const doorPoint = getDoorPoint(doorPosition, geometry.getExtent());

                    const lineGeometry = new ol.geom.LineString(getLineCoordinates(doorPosition, doorPoint));
                    const lineFeature = new ol.Feature({ geometry: lineGeometry, label: 'line' });
                    vectorSource.addFeature(lineFeature);

                    const lineStyle = new ol.style.Style({
                        stroke: new ol.style.Stroke({
                            color: '#000000',
                            width: 1
                        })
                    });
                    lineFeature.setStyle(lineStyle);

                    const textElement = document.createElement('div');
                    textElement.className = 'text-label';
                    textElement.innerHTML = `${label.label}<br>(${areaInFeet} ft&sup2)`;

                    const textOverlay = new ol.Overlay({
                        element: textElement,
                        position: center,
                        positioning: 'center-center',
                        offset: [0, 0],
                        stopEvent: false
                    });

                    map.addOverlay(textOverlay);
                    textOverlays[label.label.toLowerCase()] = textElement;

                }

                function formatCoordinate(storageUnitDetail) {
                    //console.log("storageUnitDetail", storageUnitDetail);
                    if (Object.keys(storageUnitDetail).length > 0) {
                        const { salesOrder } = storageUnitDetail;
                        let contract, customerName, startDate, endDate, salesOrderUrl;
                        if (salesOrder && salesOrder.length > 0) {
                            ({ contract, customerName, startDate, endDate, salesOrderUrl } = salesOrder[0]);
                        }
                        const { price, width, height, storageUnitUrl } = storageUnitDetail;

                        let result = '';
                        if (price) result += `<div><b>Price</b>: ${price}</div>`;
                        // if (width) result += `<div><b>Width</b>: ${width}</div>`;
                        // if (height) result += `<div><b>Height</b>: ${height}</div>`;
                        if (contract) result += `<div><b>Contract</b>: ${contract}</div>`;
                        if (customerName) result += `<div class="customer-name-text"><b>Customer Name</b>: ${customerName}</div>`;
                        if (startDate) result += `<div><b>Start Date</b>: ${startDate}</div>`;
                        if (endDate) result += `<div><b>End Date</b>: ${endDate}</div>`;
                        if (storageUnitUrl) result += `<div><b>Storage Unit</b>: <a href=${storageUnitUrl} target="blank">Link</a></div>`;

                        return result || `<div>No data Found</div>`;
                    } else {
                        return `<div>No data Found</div>`;
                    }
                }

                function addCorridorTextLabels(source, corridorTextFeatures) {

                    if (corridorTextFeatures.length > 0) {
                        corridorTextFeatures.forEach(corridor => {
                            const feature = new ol.Feature({
                                geometry: new ol.geom.Point(corridor.coordinates),
                                name: corridor.text
                            });
                            feature.setStyle(new ol.style.Style({
                                text: new ol.style.Text({
                                    font: '8pt Calibri,sans-serif',
                                    text: corridor.text,
                                    fill: new ol.style.Fill({ color: '#000' }),
                                    //stroke: new ol.style.Stroke({ color: '#fcc115', width: 2 }),
                                    rotation: corridor.rotation
                                })
                            }));
                            source.addFeature(feature);
                        });
                    }
                }

                const popElement = document.getElementById('info_popup');
                const popup = new ol.Overlay({ element: popElement, });
                map.addOverlay(popup);

                map.on('click', function (event) {
                    console.log("storageUnit click function():: event", event)
                    if (popover) {
                        popover.dispose();
                        popover = undefined;
                    }

                    const feature = map.getFeaturesAtPixel(event.pixel)?.[0];
                    if (!feature) return;

                    const extent = feature.getGeometry().getExtent();
                    const center = ol.extent.getCenter(extent);
                    const floorId = feature.get('floor');
                    const storageLabel = feature.get('label');
                    const status = feature.get('status');

                    const resultObj = mapArr?.storeUnitsFloorMapObj[floorId]?.filter(a => a.label.label == storageLabel);
                    //if (status.label == 'Occupied' || status.label == 'AVAILABLE_IN_TWO_WEEKS') {
                    popup.setPosition([center[0], center[1]]);
                    popover = new bootstrap.Popover(popElement, {
                        container: popElement,
                        animation: false,
                        content: formatCoordinate(resultObj ? resultObj[0] : {}),
                        html: true,
                        placement: 'top',
                        sanitize: false,
                        title: storageLabel
                    });
                    popover.show();
                    //}
                });

                mapDataArr?.forEach((feature, index) => {

                    const { xCoordinate, yCoordinate, width, height, availabilityStatus, label, floor, doorPosition, areaInFeet } = feature;

                    const coordinates = [
                        [xCoordinate, yCoordinate],
                        [xCoordinate + width, yCoordinate],
                        [xCoordinate + width, yCoordinate + height],
                        [xCoordinate, yCoordinate + height],
                        [xCoordinate, yCoordinate]
                    ];

                    const polygon = new ol.geom.Polygon([coordinates]);
                    const customFeature = new ol.Feature({
                        geometry: polygon,
                        status: availabilityStatus,
                        label: label.label,
                        storageId: label.value,
                        floor: floor.value,
                        doorPosition: doorPosition.value,
                        areaInFeet: areaInFeet
                    });

                    vectorSource.addFeature(customFeature);
                    createTextOverlay(customFeature, label, index, width, height, areaInFeet);
                });

                const extent = vectorSource.getExtent();
                map.getView().fit(extent, { padding: [10, 10, 10, 10], maxZoom: 15 });
                appendFilterOption(mapDataArr)
                updateTextLabelSizes();
                map.getView().on('change:resolution', updateTextLabelSizes);
                addCorridorTextLabels(corridorTextLayer.getSource(), corridorTextFeatures);

                $('#unit_slect2_search').select2({
                    allowClear: true,
                    placeholder: "Select a Unit",
                }).on("change", function (e) {
                    var selectedOption = $(this).find("option:selected");
                    var selectedLabel = selectedOption.length ? selectedOption.text() : null;

                    console.log("selectedLabel", selectedLabel);

                    if (selectedLabel) {
                        searchByName(selectedLabel);
                    } else {
                        const extent = vectorSource.getExtent();
                        map.getView().fit(extent, { padding: [10, 10, 10, 10], maxZoom: 15 });
                    }
                });
                return map;
            }

            function appendFilterOption(mapDataArr) {
                $('#unit_slect2_search').append(new Option('', ''))
                $.each(mapDataArr, function (index, option) {
                    $('#unit_slect2_search').append(new Option(option.label.label, option.label.value));
                });
            }

            function getAllFeaturesFromMap(map) {
                if (map) {
                    const features = [];
                    currentMap.getLayers().forEach(layer => {
                        if (layer instanceof ol.layer.Vector) {
                            const source = layer.getSource();
                            if (source) {
                                const layerFeatures = source.getFeatures();
                                features.push(...layerFeatures);
                            }
                        }
                    });
                    return features;
                }
            }

            function filterBySize(selectedValue) {

                const features = getAllFeaturesFromMap(currentMap)
                console.log("features", features)
                // const features = vectorSource.getFeatures();
                const highlightStyle = new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: 'black',
                        width: 0.5
                    }),
                    fill: new ol.style.Fill({
                        color: '#AC82D1'
                    })
                });

                highlightedFeatures.forEach(el => { el.setStyle(null); });
                highlightedFeatures = [];

                let filteredFeatures;
                if (selectedValue === '1') {
                    filteredFeatures = features.filter(el => el.get('areaInFeet') <= 100);
                    $('#filter_by_size').empty().append(`(${filteredFeatures.length > 0 ? filteredFeatures.length : '0'})`)
                } else if (selectedValue === '2') {
                    filteredFeatures = features.filter(el => el.get('areaInFeet') > 100 && el.get('areaInFeet') <= 150);
                    $('#filter_by_size').empty().append(`(${filteredFeatures.length > 0 ? filteredFeatures.length : '0'})`)
                } else if (selectedValue === '3') {
                    filteredFeatures = features.filter(el => el.get('areaInFeet') > 150);
                    $('#filter_by_size').empty().append(`(${filteredFeatures.length > 0 ? filteredFeatures.length : '0'})`)
                } else {
                    $('#filter_by_size').empty().append(`(0)`)
                }
                console.log("filteredFeatures", filteredFeatures);

                if (filteredFeatures) {
                    if (filteredFeatures.length > 0) {
                        filteredFeatures.forEach(el => {
                            el.setStyle(highlightStyle);
                            highlightedFeatures.push(el);
                        });
                    }
                    else {
                        alert("No Record Found...!");
                    }
                }
            }


            $('#floor_unit_size_filter').select2({
                allowClear: true,
                placeholder: "Filter by Size",
            }).on("change", function (e) {
                const selectedValue = $(this).val();
                console.log("selectedValue", selectedValue)
                filterBySize(selectedValue);
            });



            function axiosPostcall() {
                axios.post(url, JSON.stringify({
                    page: 'dashboard'
                })).then((response) => {

                    console.log("response", response);
                    mapArr = response?.data;
                    const groundFloorSummary = mapArr.floorDetailsMapObj[floorIds.GROUND_FLOOR]

                    if (groundFloorSummary) {
                        updateFloorSummary(groundFloorSummary)
                    }

                    currentMap = initializeMap('floor_map', mapArr.storeUnitsFloorMapObj[floorIds.GROUND_FLOOR], Ground_floor_corridor)
                    document.getElementById('loading-overlay').style.display = 'none';
                });
            };
            axiosPostcall()

            function destroyMap() {
                if (currentMap) {
                    // currentMap.getOverlays().clear();
                    // currentMap.getLayers().clear();
                    currentMap.setTarget(null);
                    currentMap = null;
                }
            }

            function updateFloorSummary(floorSummary) {
                if (floorSummary) {
                    $('#occupied_units').empty().append(`(${floorSummary.occupiedUnits})`);
                    $('#availaible_units').empty().append(`(${floorSummary.availableUnits})`);
                    $('#availaible_soon_units').empty().append(`(${floorSummary.availableWithinTwoWeeks})`);
                    $('#not_availaible_units').empty().append(`(${floorSummary.notAvailable})`);
                    $('#expire_units').empty().append(`(${floorSummary.expired})`);
                    $('#filter_by_size').empty().append(`(0)`);
                }
            }

            function resetFilters() {
                //$('#floor_unit_size_filter').select2('destroy')
                $('#floor_unit_size_filter').val(null).trigger('change')
                $('#unit_slect2_search').select2('destroy').empty();
            }

            function loadFloorMap(mapData, corridorTextFeatures, floorSummary) {
                destroyMap();
                resetFilters();
                currentMap = initializeMap('floor_map', mapData, corridorTextFeatures);
                updateFloorSummary(floorSummary);
            }

            // EventListener
            document.getElementById('floor_select').addEventListener('change', function (e) {
                const floorValue = e.target.value;
                console.log("floorValue", floorValue);

                const infoPopupDiv = document.createElement('div');
                infoPopupDiv.id = 'info_popup';

                // Append the info_popup div to the floor_map div
                const targetDiv = document.getElementById('floor_map');
                targetDiv.appendChild(infoPopupDiv);

                if (floorValue === floorIds.GROUND_FLOOR) {
                    loadFloorMap(mapArr.storeUnitsFloorMapObj[floorIds.GROUND_FLOOR], Ground_floor_corridor, mapArr.floorDetailsMapObj[floorIds.GROUND_FLOOR]);
                } else if (floorValue === floorIds.FLOOR_1) {
                    loadFloorMap(mapArr.storeUnitsFloorMapObj[floorIds.FLOOR_1], first_floor_corridor, mapArr.floorDetailsMapObj[floorIds.FLOOR_1]);
                } else if (floorValue === floorIds.FLOOR_2) {
                    loadFloorMap(mapArr.storeUnitsFloorMapObj[floorIds.FLOOR_2], second_floor_corridor, mapArr.floorDetailsMapObj[floorIds.FLOOR_2]);
                }

            });
        });
    </script>

</body>

</html>